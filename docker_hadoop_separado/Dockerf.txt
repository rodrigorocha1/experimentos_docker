FROM openjdk:8-jdk


ENV JAVA_HOME=/usr/local/openjdk-8
ENV PATH=$JAVA_HOME/bin:$PATH


ENV HADOOP_VERSION=3.4.1
ENV HADOOP_HOME=/home/hadoop/apache/hadoop
ENV PATH=$PATH:$HADOOP_HOME/bin:$HADOOP_HOME/sbin

# Instala pacotes necessários
RUN apt-get update && apt-get install -y wget ssh rsync sudo && \
    apt-get clean && rm -rf /var/lib/apt/lists/*

# Cria usuário hadoop com permissão sudo sem senha
RUN useradd -m -s /bin/bash hadoop && echo "hadoop ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers

# Troca para usuário hadoop para instalar Hadoop e configurar ambiente
USER hadoop
WORKDIR /home/hadoop

# Cria diretórios para Hadoop e baixa/instala Hadoop
RUN mkdir -p /home/hadoop/apache && \
    wget https://dlcdn.apache.org/hadoop/common/hadoop-$HADOOP_VERSION/hadoop-$HADOOP_VERSION.tar.gz && \
    tar -xzf hadoop-$HADOOP_VERSION.tar.gz -C /home/hadoop/apache && \
    mv /home/hadoop/apache/hadoop-$HADOOP_VERSION $HADOOP_HOME && \
    rm hadoop-$HADOOP_VERSION.tar.gz

# Cria diretórios para persistência do HDFS
RUN mkdir -p /home/hadoop/hdfs/namenode /home/hadoop/hdfs/datanode

# Ajusta permissões para usuário hadoop
RUN sudo chown -R hadoop:hadoop /home/hadoop/hdfs /home/hadoop/apache

# Gera chave SSH para o usuário hadoop (necessário para Hadoop)
RUN ssh-keygen -t rsa -P "" -f /home/hadoop/.ssh/id_rsa && \
    cat /home/hadoop/.ssh/id_rsa.pub >> /home/hadoop/.ssh/authorized_keys && \
    chmod 0600 /home/hadoop/.ssh/authorized_keys

# Copia arquivos de configuração do Hadoop com permissão correta
COPY --chown=hadoop:hadoop core-site.xml $HADOOP_HOME/etc/hadoop/core-site.xml
COPY --chown=hadoop:hadoop hdfs-site.xml $HADOOP_HOME/etc/hadoop/hdfs-site.xml
COPY --chown=hadoop:hadoop yarn-site.xml $HADOOP_HOME/etc/hadoop/yarn-site.xml
COPY --chown=hadoop:hadoop mapred-site.xml $HADOOP_HOME/etc/hadoop/mapred-site.xml

# Copia o script de entrypoint e dá permissão de execução
COPY --chown=hadoop:hadoop entrypoint.sh /home/hadoop/entrypoint.sh
RUN chmod +x /home/hadoop/entrypoint.sh

# Expõe as portas padrão dos serviços Hadoop
EXPOSE 9870 9864 8088 8042

# Define o entrypoint
ENTRYPOINT ["/home/hadoop/entrypoint.sh"]

# Mantém o container ativo com bash (caso o entrypoint finalize)
CMD ["/bin/bash"]
